<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Instrumento Docente STEM + IA (Likert + Test)</title>
  <style>
    :root{
      --bg1:#667eea; --bg2:#764ba2;
      --card:#ffffff; --muted:#6b7280; --text:#111827;
      --green:#10b981; --green2:#059669;
      --border:#e5e7eb; --soft:#f3f4f6;
      --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      min-height:100vh; padding:20px;
      color:var(--text);
    }
    .container{
      max-width:980px; margin:0 auto;
      background:var(--card);
      border-radius:18px;
      box-shadow:0 20px 45px rgba(0,0,0,.15);
      overflow:hidden;
    }
    .header{
      background: linear-gradient(135deg, var(--green) 0%, var(--green2) 100%);
      color:#fff; padding:34px 26px; text-align:center;
    }
    .header h1{font-weight:700; font-size:1.8rem; margin-bottom:8px}
    .header p{opacity:.95; line-height:1.4}
    .content{padding:26px}
    .card{
      background: #fff;
      border: 1px solid var(--border);
      border-radius:14px;
      padding:18px;
      margin-bottom:16px;
    }
    .card.soft{background:var(--soft)}
    .title-row{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .badge{
      display:inline-block; padding:6px 10px; border-radius:999px;
      background:rgba(16,185,129,.12); color:var(--green2);
      font-weight:700; font-size:.82rem;
      border:1px solid rgba(16,185,129,.25);
    }
    .muted{color:var(--muted); font-size:.95rem; line-height:1.5}
    .small{font-size:.88rem}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:760px){ .grid2{grid-template-columns:1fr} }
    label{display:block; font-weight:700; margin:10px 0 6px}
    input, select{
      width:100%; padding:12px 12px; border-radius:10px;
      border: 2px solid var(--border);
      font-size:1rem;
      outline:none;
    }
    input:focus, select:focus{border-color: rgba(16,185,129,.85)}
    .note{
      margin-top:8px; padding:10px 12px; border-radius:12px;
      background: rgba(245,158,11,.10); border: 1px solid rgba(245,158,11,.25);
      color:#92400e;
    }
    .progress{
      height:10px; background:rgba(229,231,235,.9);
      border-radius:999px; overflow:hidden; margin:14px 0 18px;
    }
    .progress > div{
      height:100%; width:0%;
      background: linear-gradient(90deg, var(--green), var(--green2));
      transition:width .25s ease;
    }
    .btn-row{display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap; margin-top:14px}
    .btn{
      border:none; cursor:pointer;
      padding:12px 18px; border-radius:999px;
      font-weight:800; font-size:1rem;
      background: linear-gradient(135deg, var(--green), var(--green2));
      color:#fff;
      box-shadow: 0 10px 22px rgba(16,185,129,.25);
      transition: transform .12s ease;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.secondary{
      background:#6b7280; box-shadow:0 10px 22px rgba(107,114,128,.25);
    }
    .btn.danger{background:var(--danger); box-shadow:0 10px 22px rgba(239,68,68,.25)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .screen{display:none}
    .screen.active{display:block}
    .dim-title{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .dim-title h3{font-size:1.12rem}
    .likert-scale{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin:10px 0 0;
      color:var(--muted);
    }
    .item{
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      margin:10px 0;
      background:#fff;
    }
    .item .q{font-weight:700; margin-bottom:10px; line-height:1.4}
    .likert{
      display:grid;
      grid-template-columns: repeat(5, minmax(44px, 1fr));
      gap:8px;
      align-items:center;
    }
    .likert label{
      margin:0; font-weight:700; font-size:.9rem; text-align:center;
      border:2px solid var(--border);
      border-radius:12px;
      padding:10px 0;
      cursor:pointer;
      user-select:none;
      background:#fff;
      transition:.12s ease;
    }
    .likert input{display:none}
    .likert input:checked + span{
      display:block;
      background: rgba(16,185,129,.12);
      border:2px solid rgba(16,185,129,.55);
      color: var(--green2);
      border-radius:12px;
      padding:10px 0;
      font-weight:900;
    }
    .likert label span{
      display:block;
      border-radius:12px;
      padding:10px 0;
      border:2px solid transparent;
    }
    .test-q{
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      margin:12px 0;
      background:#fff;
    }
    .test-q .q{font-weight:800; margin-bottom:10px; line-height:1.4}
    .opt{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 10px; border:1px solid var(--border);
      border-radius:12px; margin:8px 0;
      cursor:pointer;
      background:#fff;
    }
    .opt:hover{border-color: rgba(16,185,129,.55); background: rgba(16,185,129,.06)}
    .opt input{width:auto; margin-top:3px}
    .center{text-align:center}
    .alert{
      margin-top:12px; padding:12px 14px; border-radius:12px;
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
      color:#991b1b;
      display:none;
    }
    .ok{
      border:1px solid rgba(16,185,129,.35);
      background: rgba(16,185,129,.10);
      color:#065f46;
      display:none;
      margin-top:12px; padding:12px 14px; border-radius:12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üß† Instrumento Docente STEM + IA</h1>
      <p>Diagn√≥stico breve (‚â§15 min): <b>Likert por dimensiones</b> + <b>Mini test</b>. Resultados para an√°lisis acad√©mico.</p>
    </div>

    <div class="content">
      <div class="progress"><div id="progressFill"></div></div>

      <!-- SCREEN 1: START -->
      <section id="screenStart" class="screen active">
        <div class="card soft">
          <div class="title-row">
            <span class="badge">Inicio</span>
            <span class="muted small">Tiempo estimado: 12‚Äì15 min</span>
          </div>
          <p class="muted">
            Este instrumento busca caracterizar aspectos relacionados con la integraci√≥n de STEM, pensamiento computacional e IA en la pr√°ctica docente.
            <br><br>
            <b>No hay respuestas ‚Äúbuenas‚Äù o ‚Äúmalas‚Äù</b> en la secci√≥n Likert. En el mini test se incluyen preguntas conceptuales breves.
          </p>
        </div>

        <div class="card">
          <div class="title-row">
            <span class="badge">Confidencialidad</span>
          </div>
          <p class="muted">
            La informaci√≥n se usar√° √∫nicamente con fines acad√©micos. El an√°lisis se presentar√° de forma agregada y an√≥nima.
          </p>
        </div>

        <div class="btn-row">
          <button class="btn" onclick="goTo('screenTeacher')">Continuar ‚ûú</button>
        </div>
      </section>

      <!-- SCREEN 2: TEACHER INFO -->
      <section id="screenTeacher" class="screen">
        <div class="card">
          <div class="title-row">
            <span class="badge">Datos del docente</span>
            <span class="muted small">Campos con * son obligatorios</span>
          </div>

          <div class="grid2">
            <div>
              <label>Nombres *</label>
              <input id="nombres" type="text" placeholder="Ej: Juan Carlos" required>
            </div>
            <div>
              <label>Apellidos *</label>
              <input id="apellidos" type="text" placeholder="Ej: Garc√≠a P√©rez" required>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>N√∫mero de identificaci√≥n (opcional)</label>
              <input id="identificacion" type="text" placeholder="Opcional">
              <div class="note small">
                Se solicita √∫nicamente para control de duplicados. En el an√°lisis y reporte se tratar√° de forma an√≥nima y agregada.
              </div>
            </div>
            <div>
              <label>Instituci√≥n Educativa</label>
              <input id="institucion" type="text" placeholder="Opcional">
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>Grado que orienta *</label>
              <select id="grado" required>
                <option value="">Seleccione...</option>
                <option>Preescolar</option>
                <option>1¬∞ Primaria</option><option>2¬∞ Primaria</option><option>3¬∞ Primaria</option><option>4¬∞ Primaria</option><option>5¬∞ Primaria</option>
                <option>6¬∞ Secundaria</option><option>7¬∞ Secundaria</option><option>8¬∞ Secundaria</option><option>9¬∞ Secundaria</option>
                <option>10¬∞ Media</option><option>11¬∞ Media</option><option>M√∫ltiples</option>
              </select>
            </div>
            <div>
              <label>Asignatura principal *</label>
              <select id="asignatura" required>
                <option value="">Seleccione...</option>
                <option>Ciencias Naturales</option>
                <option>Matem√°ticas</option>
                <option>Tecnolog√≠a e Inform√°tica</option>
                <option>F√≠sica</option><option>Qu√≠mica</option><option>Biolog√≠a</option>
                <option>Integrada STEM</option>
                <option>Otra</option>
              </select>
            </div>
          </div>
        </div>

        <div class="btn-row">
          <button class="btn secondary" onclick="goTo('screenStart')">‚üµ Atr√°s</button>
          <button class="btn" onclick="validateTeacherAndGo()">Continuar ‚ûú</button>
        </div>
      </section>

      <!-- SCREEN 3: LIKERT -->
      <section id="screenLikert" class="screen">
        <div class="card soft">
          <div class="title-row">
            <span class="badge">Secci√≥n Likert</span>
            <span class="muted small">Escala 1‚Äì5</span>
          </div>
          <div class="muted small">
            1 = Totalmente en desacuerdo ¬∑ 2 = En desacuerdo ¬∑ 3 = Ni de acuerdo ni en desacuerdo ¬∑ 4 = De acuerdo ¬∑ 5 = Totalmente de acuerdo
          </div>
        </div>

        <div id="likertContainer"></div>

        <div class="alert" id="likertAlert">Por favor responde todos los √≠tems (20) antes de continuar.</div>

        <div class="btn-row">
          <button class="btn secondary" onclick="goTo('screenTeacher')">‚üµ Atr√°s</button>
          <button class="btn" onclick="validateLikertAndGo()">Continuar al mini test ‚ûú</button>
        </div>
      </section>

      <!-- SCREEN 4: TEST -->
      <section id="screenTest" class="screen">
        <div class="card soft">
          <div class="title-row">
            <span class="badge">Mini test</span>
            <span class="muted small">10 preguntas (selecci√≥n m√∫ltiple)</span>
          </div>
          <p class="muted small">Responde seg√∫n tu conocimiento. Esta secci√≥n es breve y busca caracterizaci√≥n conceptual.</p>
        </div>

        <div id="testContainer"></div>

        <div class="alert" id="testAlert">Por favor responde las 10 preguntas antes de enviar.</div>
        <div class="alert" id="sendAlert">No se pudo enviar. Verifica tu conexi√≥n e int√©ntalo de nuevo.</div>
        <div class="ok" id="sendOk">Env√≠o exitoso. Redirigiendo‚Ä¶</div>

        <div class="btn-row">
          <button class="btn secondary" onclick="goTo('screenLikert')">‚üµ Atr√°s</button>
          <button class="btn" id="btnSend" onclick="finalizeAndSend()">Enviar respuestas ‚úÖ</button>
        </div>
      </section>

      <!-- SCREEN 5: THANKS -->
      <section id="screenThanks" class="screen">
        <div class="card soft center">
          <div class="title-row" style="justify-content:center;">
            <span class="badge">Enviado</span>
          </div>
          <h2 style="margin:10px 0 10px;">‚úÖ Gracias por tu participaci√≥n</h2>
          <p class="muted" style="max-width:760px;margin:0 auto;">
            Tus respuestas aportan a fortalecer la educaci√≥n STEM y a dise√±ar experiencias con pensamiento computacional e IA m√°s pertinentes para nuestros estudiantes.
            <b>¬°Gracias por seguir ense√±ando e inspirando!</b>
          </p>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwrE575fVvk-bMYIuqtK5Gm9Yw0TMVo2bFLx_t-jTIVcFTgujXICFTABDUFXPVlLsZX0A/exec";

    // ====== STATE ======
    const screens = ["screenStart","screenTeacher","screenLikert","screenTest","screenThanks"];
    const progressFill = document.getElementById("progressFill");

    // ====== LIKERT MODEL (5 dimensiones x 4 √≠tems) ======
    const likertDimensions = [
      {
        id:"D1",
        name:"D1. Conocimiento STEM y fundamentos conceptuales",
        items:[
          "Tengo claridad conceptual para explicar fen√≥menos o conceptos de mi √°rea con enfoque STEM.",
          "Relaciono conceptos cient√≠ficos con situaciones reales o aplicaciones tecnol√≥gicas.",
          "Promuevo que los estudiantes argumenten con base en evidencia y razonamiento.",
          "Actualizo mis conocimientos para fortalecer mi ense√±anza en √°reas STEM."
        ]
      },
      {
        id:"D2",
        name:"D2. Integraci√≥n pedag√≥gica de tecnolog√≠as e IA",
        items:[
          "Integro herramientas digitales con un prop√≥sito pedag√≥gico claro (no solo por uso de tecnolog√≠a).",
          "Dise√±o actividades donde el estudiante crea o construye (por ejemplo, proyectos o retos).",
          "Considero oportuno incluir nociones de IA en el aula seg√∫n el contexto y la edad.",
          "Promuevo un uso responsable y cr√≠tico de la tecnolog√≠a y la IA."
        ]
      },
      {
        id:"D3",
        name:"D3. Pensamiento computacional y resoluci√≥n de problemas",
        items:[
          "Gu√≠o a mis estudiantes para descomponer problemas en partes m√°s manejables.",
          "Fomento que los estudiantes dise√±en pasos o algoritmos para resolver situaciones.",
          "Uso ejemplos o actividades que desarrollan abstracci√≥n (identificar lo esencial).",
          "Promuevo la depuraci√≥n: identificar errores, corregir y mejorar soluciones."
        ]
      },
      {
        id:"D4",
        name:"D4. Dise√±o e implementaci√≥n de experiencias STEM (contexto)",
        items:[
          "Planeo actividades STEM conectadas con el entorno o la realidad de los estudiantes.",
          "Formulo retos o problemas aut√©nticos que integran m√°s de un √°rea (interdisciplinariedad).",
          "Promuevo iteraci√≥n (mejoras) durante el desarrollo de proyectos o prototipos.",
          "Facilito trabajo colaborativo con roles y metas claras en proyectos STEM."
        ]
      },
      {
        id:"D5",
        name:"D5. Evaluaci√≥n, reflexi√≥n y mejora de la pr√°ctica docente",
        items:[
          "Utilizo r√∫bricas u otros criterios claros para evaluar procesos y productos de proyectos.",
          "Realizo retroalimentaci√≥n formativa para mejorar aprendizajes (no solo calificar).",
          "Recojo evidencias del aprendizaje (portafolios, bit√°coras, prototipos, etc.).",
          "Reflexiono sobre mis clases para ajustar estrategias y mejorar resultados."
        ]
      }
    ];

    // ====== TEST MODEL (10 preguntas con respuesta correcta) ======
    const testQuestions = [
      {
        id:"T1",
        q:"¬øCu√°l es el principio fundamental del pensamiento computacional?",
        options:["Programaci√≥n","Uso de computadoras","Algoritmos complejos","Descomposici√≥n de problemas"],
        correct:3
      },
      {
        id:"T2",
        q:"¬øQu√© subhabilidad corresponde a identificar patrones o similitudes entre problemas?",
        options:["Abstracci√≥n","Reconocimiento de patrones","Depuraci√≥n","Simulaci√≥n"],
        correct:1
      },
      {
        id:"T3",
        q:"En una actividad con IA (p.ej., Teachable Machine), ¬øqu√© es un ‚Äúdato de entrenamiento‚Äù?",
        options:["La nota final","Un ejemplo usado para ense√±ar al modelo","El algoritmo del docente","Un tipo de sensor"],
        correct:1
      },
      {
        id:"T4",
        q:"¬øCu√°l es la primera etapa del proceso de dise√±o en ingenier√≠a?",
        options:["Identificar el problema","Construir el prototipo","Probar la soluci√≥n","Elegir materiales"],
        correct:0
      },
      {
        id:"T5",
        q:"¬øQu√© significa ‚Äúdepurar‚Äù en programaci√≥n/pensamiento computacional?",
        options:["Hacer el programa m√°s largo","Encontrar y corregir errores","Cambiar el lenguaje","Ejecutar m√°s r√°pido"],
        correct:1
      },
      {
        id:"T6",
        q:"Al ense√±ar IA, ¬øqu√© consideraci√≥n √©tica es especialmente importante?",
        options:["Velocidad de procesamiento","Costo computacional","Sesgo algor√≠tmico y equidad","Cantidad de memoria"],
        correct:2
      },
      {
        id:"T7",
        q:"¬øQu√© describe mejor la abstracci√≥n en pensamiento computacional?",
        options:["Memorizar pasos","Ignorar lo relevante","Enfocarse en lo esencial y omitir detalles innecesarios","Usar solo computadores"],
        correct:2
      },
      {
        id:"T8",
        q:"¬øQu√© caracter√≠stica define mejor una experiencia STEM interdisciplinaria exitosa?",
        options:["Tecnolog√≠a avanzada","Conexiones aut√©nticas entre disciplinas","Muchos estudiantes","Proyecto muy largo"],
        correct:1
      },
      {
        id:"T9",
        q:"¬øCu√°l es el prop√≥sito principal de usar microcontroladores (p. ej., Micro:Bit) en el aula?",
        options:["Reemplazar libros","Hacer solo presentaciones","Conectar lo digital con lo f√≠sico en soluciones","Evitar el trabajo colaborativo"],
        correct:2
      },
      {
        id:"T10",
        q:"¬øQu√© pr√°ctica favorece mejor el aprendizaje activo en STEM?",
        options:["Memorizar definiciones","Proyectos basados en problemas del contexto","Solo clase magistral","Copiar ejercicios"],
        correct:1
      }
    ];

    // ====== UI RENDER ======
    function goTo(id){
      screens.forEach(s => document.getElementById(s).classList.remove("active"));
      document.getElementById(id).classList.add("active");
      updateProgress(id);
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function updateProgress(screenId){
      const idx = screens.indexOf(screenId);
      const pct = Math.max(0, Math.round((idx / (screens.length - 1)) * 100));
      progressFill.style.width = pct + "%";
    }

    function renderLikert(){
      const container = document.getElementById("likertContainer");
      container.innerHTML = "";

      likertDimensions.forEach(dim => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="dim-title">
            <h3>${dim.name}</h3>
            <span class="badge">4 √≠tems</span>
          </div>
        `;

        dim.items.forEach((text, idx) => {
          const itemId = `${dim.id}_Q${idx+1}`;
          const item = document.createElement("div");
          item.className = "item";
          item.innerHTML = `
            <div class="q">${text}</div>
            <div class="likert" role="radiogroup" aria-label="${itemId}">
              ${[1,2,3,4,5].map(v => `
                <label>
                  <input type="radio" name="${itemId}" value="${v}">
                  <span>${v}</span>
                </label>
              `).join("")}
            </div>
          `;
          card.appendChild(item);
        });

        container.appendChild(card);
      });
    }

    function renderTest(){
      const container = document.getElementById("testContainer");
      container.innerHTML = "";

      testQuestions.forEach((t, i) => {
        const div = document.createElement("div");
        div.className = "test-q";
        div.innerHTML = `
          <div class="q">${i+1}. ${t.q}</div>
          ${t.options.map((opt, j) => `
            <label class="opt">
              <input type="radio" name="${t.id}" value="${j}">
              <span>${opt}</span>
            </label>
          `).join("")}
        `;
        container.appendChild(div);
      });
    }

    // init renders
    renderLikert();
    renderTest();
    updateProgress("screenStart");

    // ====== VALIDATIONS ======
    function validateTeacherAndGo(){
      const req = [
        ["nombres","Nombres"],
        ["apellidos","Apellidos"],
        ["grado","Grado"],
        ["asignatura","Asignatura"]
      ];

      for (const [id, label] of req){
        const el = document.getElementById(id);
        if (!el.value || !String(el.value).trim()){
          el.focus();
          alert(`Por favor completa: ${label}.`);
          return;
        }
      }
      goTo("screenLikert");
    }

    function validateLikertAndGo(){
      document.getElementById("likertAlert").style.display = "none";

      const totalItems = 20;
      let answered = 0;

      likertDimensions.forEach(dim => {
        dim.items.forEach((_, idx) => {
          const name = `${dim.id}_Q${idx+1}`;
          const v = document.querySelector(`input[name="${name}"]:checked`);
          if (v) answered++;
        });
      });

      if (answered !== totalItems){
        document.getElementById("likertAlert").style.display = "block";
        return;
      }
      goTo("screenTest");
    }

    function validateTest(){
      document.getElementById("testAlert").style.display = "none";
      for (const t of testQuestions){
        const v = document.querySelector(`input[name="${t.id}"]:checked`);
        if (!v){
          document.getElementById("testAlert").style.display = "block";
          return false;
        }
      }
      return true;
    }

    // ====== COMPUTE ======
    function getTeacherInfo(){
      return {
        nombres: document.getElementById("nombres").value.trim(),
        apellidos: document.getElementById("apellidos").value.trim(),
        identificacion: document.getElementById("identificacion").value.trim(),
        grado: document.getElementById("grado").value,
        asignatura: document.getElementById("asignatura").value,
        institucion: document.getElementById("institucion").value.trim()
      };
    }

    function computeLikert(){
      const itemAnswers = {};
      const dimAverages = {};
      let allVals = [];

      likertDimensions.forEach(dim => {
        let vals = [];
        dim.items.forEach((_, idx) => {
          const name = `${dim.id}_Q${idx+1}`;
          const v = Number(document.querySelector(`input[name="${name}"]:checked`).value);
          itemAnswers[name] = v;
          vals.push(v);
          allVals.push(v);
        });
        const avg = round2(vals.reduce((a,b)=>a+b,0) / vals.length);
        dimAverages[dim.id] = avg;
      });

      const global = round2(allVals.reduce((a,b)=>a+b,0) / allVals.length);

      return { itemAnswers, dimAverages, global };
    }

    function computeTestScore(){
      const answers = {};
      let correct = 0;

      testQuestions.forEach(t => {
        const chosen = Number(document.querySelector(`input[name="${t.id}"]:checked`).value);
        answers[t.id] = chosen;
        if (chosen === t.correct) correct++;
      });

      const pct = Math.round((correct / testQuestions.length) * 100);

      let level = "Inicial";
      if (pct >= 85) level = "Avanzado";
      else if (pct >= 70) level = "Intermedio";
      else if (pct >= 50) level = "B√°sico";

      return { answers, correct, total: testQuestions.length, pct, level };
    }

    function round2(n){ return Math.round(n * 100) / 100; }

    async function sha256(text){
      if (!text) return "";
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
    }

    // ====== SEND ======
async function submitResults(payload){
  const res = await fetch(APPS_SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify(payload) // sin headers => text/plain => sin preflight
  });

  // Apps Script devuelve JSON; intentamos leerlo
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { ok:false, raw:text }; }
}

    async function finalizeAndSend(){
      document.getElementById("sendAlert").style.display = "none";
      document.getElementById("sendOk").style.display = "none";

      if (!validateTest()) return;

      const btn = document.getElementById("btnSend");
      btn.disabled = true;

      try{
        const docente = getTeacherInfo();
        const likert = computeLikert();
        const test = computeTestScore();
        const id_hash = await sha256(docente.identificacion || "");

        // Payload: guarda promedios + respuestas item a item (ideal tesis)
        const payload = {
          timestamp: new Date().toISOString(),
          nombres: docente.nombres,
          apellidos: docente.apellidos,
          id_hash,
          grado: docente.grado,
          asignatura: docente.asignatura,
          institucion: docente.institucion || "No especificada",

          Likert_global: likert.global,
          D1_avg: likert.dimAverages.D1,
          D2_avg: likert.dimAverages.D2,
          D3_avg: likert.dimAverages.D3,
          D4_avg: likert.dimAverages.D4,
          D5_avg: likert.dimAverages.D5,

          test_correct: test.correct,
          test_total: test.total,
          test_score: test.pct,
          test_level: test.level,

          // detalle Likert (20)
          ...likert.itemAnswers,

          // detalle Test (10)
          ...Object.fromEntries(Object.entries(test.answers).map(([k,v]) => [`${k}_ans`, v]))
        };

        const r = await submitResults(payload);

        if (!r || r.ok !== true){
          throw new Error("Respuesta no OK del servidor");
        }

        document.getElementById("sendOk").style.display = "block";
        setTimeout(() => goTo("screenThanks"), 650);

      }catch(err){
        console.error(err);
        document.getElementById("sendAlert").style.display = "block";
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
